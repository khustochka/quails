-# frozen_string_literal: true
- @body_class = 'wider'
-# no_viewport is for very wide pages, e.g. with table
- @no_viewport = true

- stylesheet 'forms'
- @js_features = [:wikiFields]
- @js_controller = :cards

- @page_title = @card.persisted? ? "Edit: #{link_to l(@card.observ_date, format: :long), day_path(@card.observ_date)}, #{@card.locus.decorated.short_full_name}".html_safe : "New card"

- if @card.persisted?

  %h1= page_header

  - provide :add_shortcuts do
    %li= link_to @card.mapped? ? 'Edit map' : '<b>MAP IT!</b>'.html_safe, edit_map_path(q: {card_id: @card.id})

  = render 'admin/shortcuts' if current_user.admin?

%div#notice
  - if notice
    = notice
  %b Create new card:
  - suggested_dates(@card).each do |date, words|
    = link_to words.join(", "), new_card_path(card: {observ_date: date}), class: 'suggest-date'
  \|
  %b Import from ebird:
  = form_tag import_cards_path, method: :get, class: "ebird_import_form" do
    = text_field_tag :ebird_id
    = submit_tag "Submit", name: nil

- if alert
  %p.errors= alert


-# Always add one blank observation
- @card.observations.build

= simple_form_for(@card) do |form|
  = form.error_notification

  %div
    = form.input :observ_date, as: :string, label: 'Date:',
          input_html: {class: 'short', maxlength: 10, type: 'date'}
    = form.association :locus, label: 'Location:', collection: Locus.suggestion_order
    - unless @card.persisted?
      %div.fast-locus-container
        - CardsHelper::FAST_LOCI.filter_map {|slug| fast_loci[slug]}.each do |loc|
          %span.pseudolink.fast_locus= loc.name_en
    - if @ebird_location
      %br
      %b= @ebird_location

    - @card.post.if_present do |blogpost|
      = form.input :post_id, label: post_link(blogpost.decorated.title, blogpost),
          as: :boolean, checked_value: @card.post_id, unchecked_value: ''
    - if @card.autogenerated?
      = form.input :autogenerated
    = form.input :motorless

  = form.input :notes, input_html: {rows: 7, class: 'wiki_field'}

  %div.card-fields-wrapper.cf
    = form.input :effort_type, collection: Card::EFFORT_TYPES, include_blank: false,
                               input_html: {size: '5'}, wrapper_html: {class: 'float-left'}
    = form.input :start_time, input_html: {class: 'short'}
    = form.input :duration_minutes, as: :string, input_html: {class: 'short'}
    = form.input :distance_kms, as: :string, input_html: {class: 'short'}
    = form.input :area_acres, as: :string, input_html: {class: 'short'}
    = form.input :observers, input_html: {class: 'medium'}
    = form.input :biotope
    = form.input :weather
    = form.input :kml_url, input_html: {class: 'medium'}
    = form.input :ebird_id, label: "eBird Checklist Id", input_html: {class: 'short'}

  %div.obs-block
    %div.fast-species
      = render "fast_species"

    = form.simple_fields_for :observations do |builder|
      = render 'observations/observation_fields', form: builder

  .fixed-bottom

    %div.quick-add
      .input.flat
        %label{for: 'species-quick-add'} Quick add species:
        %input{id: 'species-quick-add', class: 'string'}

      %div.to-add-row
        &laquo;
        %span.pseudolink#add-row Add new row

      .ebird-link-row
        = link_to "Find eBird taxon to promote", ebird_taxa_path, target: "_blank", rel: :noopener

    .buttons
      = form.input :resolved
      = form.button :submit, "Resolve", data: {disable_with: 'Saving...'}, id: 'resolve_button', name: 'resolve'
      = default_submit_button(form)
      = link_to 'Extract selected to a new card', extract_observations_path, class: 'pseudolink extractor'
      = link_to 'Move selected to another card', move_observations_path, class: 'pseudolink mover'
