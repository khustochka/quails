- @wider = true

- stylesheet 'forms'
- javascript 'card_form'

- @page_title = "#{new_or_edit_label(@card)} card"

%h1= page_header

= render 'admin/shortcuts' if current_user.admin?

- 1.upto(9 - @card.observations.size) do
  - @card.observations.build

-# Always add at least one blank observation
- @card.observations.build


= simple_form_for(@card) do |form|
  = form.error_notification

  %div
    = form.association :locus, label: 'Location:', collection: Locus.suggestion_order,
        input_html: {class: 'suggest-combo'}
    = form.input :observ_date, as: :string, label: 'Date:',
          input_html: {class: 'short', maxlength: 10, type: 'date'}
    - if blogpost = @card.post
      = form.input :post_id, label: post_link(blogpost.formatted.title, blogpost),
          as: :boolean, checked_value: @card.post_id, unchecked_value: ''

    = form.input :autogenerated

  %div
    = form.input :biotope
    = form.input :weather
    = form.input :time
  %div
    = form.input :route
    = form.input :observers
    = form.input :with_me, label: 'With me'

  = form.input :notes, input_html: {rows: 7}

  %div.quick-add
    .input.flat
      %label{for: 'species-quick-add'} Quick add species:
      %input{id: 'species-quick-add', class: 'string'}

  = form.simple_fields_for :observations do |form2|
    - obs = form2.object
    %div.obs-row
      = form2.association :species, collection: species_for_select,
          include_blank: true, required: false, input_html: {class: 'sp-suggest'}
      = form2.input :mine, label: 'Mine?'
      = form2.input :quantity, input_html: {class: :short}
      = form2.input :notes
      = form2.input :voice, label: 'Voice?'
      = form2.input :place
      - if obs.persisted?
        %div.align-center
          = link_to(obs.id, edit_observation_path(obs))
          %br
          = default_destroy_link(obs)
        %div
          - if obs.post_id
            = link_to 'post', obs.post
      - else
        %div.align-center
          %span.remove= image_tag('/img/x_14x14.png', title: 'Remove row')

  %div.to-add-row
    &laquo;
    %span.pseudolink#add-row Add new row

  .buttons
    = default_submit_button(form)
